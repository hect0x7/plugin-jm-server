<!--suppress HtmlWrongAttributeValue, HtmlUnknownAttribute, HtmlUnknownTarget, HtmlUnknownTag -->
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta http-equiv="Cache-Control" content="no-cache" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>文件浏览器 | 离线看本</title>
    <!-- Keep existing FontAwesome linkage -->
    <link rel="stylesheet" href="../static/css/all.min.css">
    <link rel="stylesheet" href="../static/css/index.css?t={{ randomArg }}">
    <script src="../static/js/index.js?t={{ randomArg }}"></script>
</head>

<body>
    <div class="app-container">

        <!-- Header Section -->
        <header class="header-card">
            <div class="top-bar">
                <div class="location-info">
                    <div class="drivers-list">
                        <span>磁盘驱动器:</span>
                        {% for driver in data.drivers %}
                        <a href="javascript:" class="driver-pill" location="{{ driver }}">{{ driver }}</a>
                        {% endfor %}
                    </div>
                </div>

                <div class="nav-actions">
                    <a href="/spa?path={{ data.currentPath }}" class="btn btn-outline"
                        style="color: #10b981; border-color: #10b981; margin-right: 5px;">
                        <i class="fas fa-columns"></i> 切换新版(PC)
                    </a>
                    <button class="btn btn-outline" id="btn-show-bookmarks" onclick="toggleBookmarks()">
                        <i class="fas fa-star" style="color: #f59e0b;"></i> 收藏夹
                    </button>
                    <a href="/upload_file" class="btn btn-primary">
                        <i class="fas fa-cloud-upload-alt"></i> 上传文件
                    </a>
                    <a href="/logout" class="btn btn-outline">
                        <i class="fas fa-sign-out-alt"></i> 注销
                    </a>
                </div>
            </div>

            <div class="path-navigation">
                <div class="current-path">
                    <i class="fas fa-folder-open"></i>
                    <span id="currentPathText">{{ data.currentPath }}</span>
                </div>
            </div>

            <div class="toolbar">
                <button class="btn btn-outline" onclick="goBack()" id="btn-back">
                    <i class="fas fa-arrow-left"></i> 上级目录
                </button>
                <button class="btn btn-outline" onclick="changeDir('{{ data.defaultPath }}')">
                    <i class="fas fa-home"></i> 回到原点
                </button>
            </div>
        </header>

        <!-- Main File List -->
        <main class="file-manager-card">
            <!-- List Header (Desktop Only) -->
            <div class="file-list-header">
                <div class="header-col" onclick="sortTable('name')" data-sort="name">文件名 <span class="sort-icon"></span>
                </div>
                <div class="header-col" onclick="sortTable('size')" data-sort="size">大小 <span class="sort-icon"></span>
                </div>
                <div class="header-col desc" onclick="sortTable('date')" data-sort="date">修改日期 <span
                        class="sort-icon"></span></div>
                <div>操作</div>
                <div>预览</div>
            </div>

            <!-- File List Body -->
            <div class="file-list-body">
                {% for file in data.files %}
                <div class="file-item" data-type="{{ 'dir' if 'dir' in file.type else 'file' }}"
                    type="{{ file.jm_view }}">

                    <!-- File Name Column -->
                    <div class="file-name-col {{ file.type }}">
                        <div class="file-icon">
                            {% if 'dir' in file.type %}
                            <i class="fas fa-folder"></i>
                            {% elif file.jm_view %}
                            <i class="fas fa-book"></i>
                            {% else %}
                            <i class="fas fa-file"></i>
                            {% endif %}
                        </div>
                        <!-- IMPORTANT: Retain attributes for JS selectors -->
                        <a href="{{ file.href }}" class="file-link" dirname="{{ file.name }}" path="{{ file.path }}">
                            <!-- JS handles click via event delegation or direct onclick provided by JS -->
                            {{ file.name }}
                        </a>
                    </div>

                    <!-- Size Column -->
                    <div class="text-sm size-col">
                        {% if 'dir' in file.type %}
                        <a href="javascript:" onclick="openDir('{{ file.path }}')"
                            style="color: inherit; text-decoration: none;">{{ file.size }}</a>
                        {% else %}
                        {{ file.size }}
                        {% endif %}
                    </div>

                    <!-- Date Column -->
                    <div class="text-sm date-col">{{ file.ctime }}</div>

                    <!-- Action Column -->
                    <div class="file-action-col">
                        {% if file.jm_view %}
                        <a href="javascript:" class="action-btn"
                            onclick="openJmView('{{ file.path }}', '{{ file.type }}')">
                            <i class="fas fa-eye"></i> 看本
                        </a>
                        {% endif %}
                    </div>

                    <!-- Preview Column -->
                    <div class="preview-col">
                        {% if file.first_img_url and file.first_img_url != '' %}
                        <img src="{{ file.first_img_url.data_original }}" class="preview-img" loading="lazy"
                            alt="preview">
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </main>

        <!-- Floating Actions (Mobile/Tablet adaptation) -->
        <div class="manage-actions">
            <!-- Items could be added here if needed -->
        </div>

        <!-- Back to Top -->
        <div id="to-top" class="back-to-top">
            <i class="fas fa-arrow-up"></i>
        </div>

    </div>

    <!-- Bookmarks Drawer -->
    <div class="bookmarks-backdrop" id="bookmarks-backdrop" onclick="toggleBookmarks()"></div>
    <div class="bookmarks-drawer" id="bookmarks-drawer">
        <div class="drawer-header">
            <h2 class="drawer-title"><i class="fas fa-star" style="color: #f59e0b; margin-right: 0.5rem;"></i> 收藏夹</h2>
            <button class="btn-close" onclick="toggleBookmarks()">&times;</button>
        </div>
        <div class="drawer-content">
            <button class="bookmark-add-btn" onclick="addCurrentBookmark()">
                <i class="fas fa-plus"></i> 收藏当前目录
            </button>
            <ul class="bookmarks-list" id="bookmarks-list">
                <!-- Bookmarks will be injected here via JS -->
            </ul>
            <div id="bookmarks-empty" class="empty-state" style="display: none;">
                还没有收藏任何文件夹
            </div>
        </div>
    </div>

    <!-- Hidden Forms for Logic -->
    <form action="/" method="GET" style="display: none;" id="pathForm">
        <label>
            <input type="text" name="path" value>
        </label>
        <input type="submit">
    </form>

    <form action="/jm_view" method="GET" style="display: none;" id="jmViewForm">
        <label>
            <input name="path" value>
            <input name="openFromDir" value>
        </label>
        <input type="submit">
    </form>

</body>

</html>